<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9fafb; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; font-weight: 600; color: #555; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing:border-box; }
    .btn { width: 100%; padding: 12px; margin-top: 25px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    .btn:hover { background: #2980b9; }
    .hidden { display: none; }
    .autocomplete-list { border: 1px solid #eee; max-height: 150px; overflow-y: auto; position:absolute; background:white; width:100%; z-index:99;}
    .autocomplete-item { padding: 10px; cursor: pointer; }
    .autocomplete-item:hover { background: #f0f0f0; }
    #loading { display:none; text-align:center; font-weight:bold; margin-top:10px;}
  </style>
</head>
<body>
  <div class="container">
    <h3 id="formTitle">Mettre à jour</h3>
    
    <div style="position:relative;">
        <label>Rechercher Service Tag :</label>
        <input type="text" id="searchTag" autocomplete="off">
        <div id="tagList" class="autocomplete-list hidden"></div>
    </div>
    <button type="button" class="btn" style="background:#555; margin-top:10px;" onclick="loadData()">Charger</button>

    <hr>

    <div id="updateForm" class="hidden">
      <input type="hidden" id="originalTag">
      <label>User :</label><input type="text" id="user">
      <label>Status :</label><select id="status"></select>
      <label>Location :</label><select id="location"></select>
      <label>Company :</label><select id="company"></select>
      <label>Observation :</label><input type="text" id="observation">
      <label>Numéro Ticket (Historique) :</label><input type="text" id="ticketNumber">
      <button type="button" class="btn" onclick="submitUpdate()">Sauvegarder</button>
    </div>
    <div id="loading">Chargement...</div>
    <div id="message" style="text-align:center; margin-top:10px;"></div>
  </div>

  <script>
    const ASSET_TYPE = "<?= assetType ?>";
    const IS_LAPTOP = (ASSET_TYPE === 'LAPTOP');
    const OPTIONS = { status: <?!= JSON.stringify(status || []) ?>, location: <?!= JSON.stringify(location || []) ?>, company: <?!= JSON.stringify(company || []) ?> };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('formTitle').innerText = IS_LAPTOP ? "Update Laptop" : "Update Monitor";
      ['status', 'location', 'company'].forEach(k => {
          const sel = document.getElementById(k);
          OPTIONS[k].forEach(o => { let opt = document.createElement('option'); opt.value = o; opt.innerText = o; sel.appendChild(opt); });
      });
      
      const input = document.getElementById('searchTag');
      const list = document.getElementById('tagList');
      input.addEventListener('input', () => {
        const val = input.value.toLowerCase();
        if(val.length < 2) { list.classList.add('hidden'); return; }
        const func = IS_LAPTOP ? 'getServiceTags' : 'getServiceTagsMonitor';
        google.script.run.withSuccessHandler(tags => {
            list.innerHTML = '';
            tags.filter(t => t.toLowerCase().includes(val)).forEach(t => {
                let d = document.createElement('div'); d.className = 'autocomplete-item'; d.innerText = t;
                d.onclick = () => { input.value = t; list.classList.add('hidden'); loadData(); };
                list.appendChild(d);
            });
            list.classList.remove('hidden');
        })[func]();
      });
    });

    function loadData() {
      const tag = document.getElementById('searchTag').value;
      if(!tag) return;
      document.getElementById('loading').style.display = 'block';
      google.script.run.withSuccessHandler(data => {
        document.getElementById('loading').style.display = 'none';
        if(!data) { alert("Non trouvé"); return; }
        document.getElementById('updateForm').classList.remove('hidden');
        document.getElementById('originalTag').value = data['Service Tag'];
        document.getElementById('user').value = data['USER'] || '';
        document.getElementById('status').value = data['STATUS'] || '';
        document.getElementById('location').value = data['LOCATION'] || '';
        document.getElementById('company').value = data['COMPANY'] || '';
        document.getElementById('observation').value = data['OBSERVATION'] || '';
      }).getDeviceDataByServiceTag(tag, ASSET_TYPE);
    }

    function submitUpdate() {
      const data = {
        serviceTag: document.getElementById('originalTag').value,
        user: document.getElementById('user').value,
        status: document.getElementById('status').value,
        location: document.getElementById('location').value,
        company: document.getElementById('company').value,
        observation: document.getElementById('observation').value,
        ticketNumber: document.getElementById('ticketNumber').value
      };
      document.getElementById('loading').style.display = 'block';
      const func = IS_LAPTOP ? 'updateDevice' : 'updateMonitor';
      google.script.run.withSuccessHandler(() => {
        document.getElementById('loading').style.display = 'none';
        google.script.host.close();
      }).withFailureHandler(e => alert(e.message))[func](data);
    }
  </script>
</body>
</html>