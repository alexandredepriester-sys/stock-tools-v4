<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9fafb; padding: 20px; color: #333; }
    .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow-x: auto; }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th { background-color: #34495e; color: white; padding: 12px 8px; font-size: 0.9em; text-align: left; }
    td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .btn-primary { background-color: #2ecc71; color: white; }
    .btn-secondary { background-color: #3498db; color: white; margin-right: 10px; }
    .btn-danger { background-color: #e74c3c; color: white; }
    .hidden { display: none; }
    .error-box { background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 4px; margin-bottom: 15px; display: none; }
    .autocomplete-list { position: absolute; background: white; border: 1px solid #ddd; z-index: 10; width: 200px; max-height: 150px; overflow-y: auto; }
    .autocomplete-item { padding: 8px; cursor: pointer; }
    .autocomplete-item:hover { background: #eee; }
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:none; text-align:center; padding-top: 20%; font-weight:bold; font-size:1.2em; z-index:999; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formTitle">Ajouter des Appareils</h2>
    <div id="errorBox" class="error-box"></div>
    <form id="addForm">
      <table id="devicesTable">
        <thead>
          <tr>
            <th style="width: 120px;">Service Tag *</th>
            <th style="width: 150px;">User</th>
            <th style="width: 100px;">Model</th>
            <? if (assetType === 'LAPTOP') { ?> <th style="width: 80px;">Type</th> <? } ?>
            <th style="width: 100px;">Company</th>
            <th style="width: 100px;">Location</th>
            <th style="width: 110px;">Purchase Date</th>
            <th style="width: 100px;">Status *</th>
            <th>PO Number</th>
            <th>Invoice</th>
            <th>Provider</th>
            <? if (assetType === 'LAPTOP') { ?> <th>Micro</th><th>HDD</th><th>RAM</th> <? } ?>
            <th>Decomission</th>
            <th>Observation</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="addRow()">+ Ajouter une ligne</button>
        <button type="button" class="btn btn-primary" onclick="submitForm()">Enregistrer tout</button>
      </div>
    </form>
  </div>
  <div id="loading">Traitement en cours...</div>

  <script>
    const ASSET_TYPE = "<?= assetType ?>"; 
    const IS_LAPTOP = (ASSET_TYPE === 'LAPTOP');
    const OPTIONS = {
      model: <?!= JSON.stringify(model || modelmonitor || []) ?>,
      type: <?!= JSON.stringify(type || []) ?>,
      company: <?!= JSON.stringify(company || []) ?>,
      location: <?!= JSON.stringify(location || []) ?>,
      status: <?!= JSON.stringify(status || []) ?>,
      provider: <?!= JSON.stringify(provider || []) ?>,
      micro: <?!= JSON.stringify(micro || []) ?>,
      harddisk: <?!= JSON.stringify(harddisk || []) ?>,
      ram: <?!= JSON.stringify(ram || []) ?>
    };

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('formTitle').innerText = IS_LAPTOP ? "Ajouter des Laptops" : "Ajouter des Moniteurs";
      addRow();
    });

    function addRow() {
      const tbody = document.querySelector('#devicesTable tbody');
      const tr = document.createElement('tr');
      let html = `<td><input type="text" name="serviceTag" required></td>
        <td><input type="text" name="user" class="user-input" autocomplete="off"><div class="autocomplete-list hidden"></div></td>
        <td>${createSelect('model')}</td>`;
      if (IS_LAPTOP) html += `<td>${createSelect('type')}</td>`;
      html += `<td>${createSelect('company')}</td><td>${createSelect('location')}</td>
        <td><input type="date" name="purchaseDate"></td><td>${createSelect('status')}</td>
        <td><input type="text" name="poNumber"></td><td><input type="text" name="invoice"></td>
        <td>${createSelect('provider')}</td>`;
      if (IS_LAPTOP) html += `<td>${createSelect('micro')}</td><td>${createSelect('harddisk')}</td><td>${createSelect('ram')}</td>`;
      html += `<td><input type="date" name="decomissionDate"></td><td><input type="text" name="observation"></td>
        <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">X</button></td>`;
      tr.innerHTML = html;
      tbody.appendChild(tr);
      setupUserAutocomplete(tr.querySelector('.user-input'));
    }

    function removeRow(btn) {
      if (document.querySelector('#devicesTable tbody').rows.length > 1) btn.closest('tr').remove();
    }

    function createSelect(key) {
      let opts = OPTIONS[key] || [];
      return `<select name="${key}"><option value="">-</option>${opts.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
    }

    function setupUserAutocomplete(input) {
      const listDiv = input.nextElementSibling;
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        if (val.length < 2) { listDiv.classList.add('hidden'); return; }
        google.script.run.withSuccessHandler(users => {
          listDiv.innerHTML = '';
          users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.innerText = user;
            div.onclick = () => { input.value = user; listDiv.classList.add('hidden'); };
            listDiv.appendChild(div);
          });
          listDiv.classList.remove('hidden');
        }).getUsersAdd(val);
      });
      document.addEventListener('click', e => { if (e.target !== input) listDiv.classList.add('hidden'); });
    }

    function submitForm() {
      const rows = document.querySelectorAll('#devicesTable tbody tr');
      const data = [];
      let errors = [];

      rows.forEach((row, index) => {
        const getVal = (name) => (row.querySelector(`[name="${name}"]`) || {}).value;
        const item = {
          serviceTag: getVal('serviceTag'), user: getVal('user'), model: getVal('model'),
          company: getVal('company'), location: getVal('location'), purchaseDate: getVal('purchaseDate'),
          status: getVal('status'), poNumber: getVal('poNumber'), invoice: getVal('invoice'),
          provider: getVal('provider'), decomissionDate: getVal('decomissionDate'), observation: getVal('observation')
        };
        if (IS_LAPTOP) { item.type = getVal('type'); item.micro = getVal('micro'); item.hardDisk = getVal('harddisk'); item.ram = getVal('ram'); }
        
        if (!item.serviceTag) errors.push(`Ligne ${index + 1}: Tag manquant.`);
        if (!item.status) errors.push(`Ligne ${index + 1}: Status manquant.`);
        data.push(item);
      });

      const errorBox = document.getElementById('errorBox');
      if (errors.length > 0) { errorBox.innerHTML = errors.join('<br>'); errorBox.style.display = 'block'; return; }
      
      document.getElementById('loading').style.display = 'block';
      const func = IS_LAPTOP ? 'addLaptops' : 'addMonitors';
      google.script.run.withSuccessHandler(() => {
         document.getElementById('loading').style.display = 'none'; google.script.host.close();
      }).withFailureHandler(e => {
         document.getElementById('loading').style.display = 'none'; errorBox.innerText = e.message; errorBox.style.display='block';
      })[func](data);
    }
  </script>
</body>
</html>